#!/bin/bash

set -e

ROOT_DIR=$(git rev-parse --show-toplevel)
cd "$ROOT_DIR"

CORE_DIR="$ROOT_DIR/core"
PRIMARY_PROJECT_DIR="$CORE_DIR"
SECONDARY_PROJECT_DIR="$CORE_DIR/python-venv2"
declare -a SECONDARY_SCOPE_PATHS=()
# shellcheck disable=SC2034
declare -a EMPTY_PATHS=()
SECONDARY_COVERAGE_THRESHOLD="${SECONDARY_COVERAGE_THRESHOLD:-65}"

source "$ROOT_DIR/.hooks/lib/common.sh"
source "$ROOT_DIR/.hooks/lib/python_checks.sh"

declare -a ISORT_CONFIG_ARGS=(--settings-path "$CORE_DIR/pyproject.toml")
declare -a BLACK_CONFIG_ARGS=(--config "$CORE_DIR/pyproject.toml")
declare -a ISORT_CHECK_ARGS=(--check-only --diff)
declare -a BLACK_CHECK_ARGS=(--check --diff)

# shellcheck disable=SC2034
isort_args=("${ISORT_CONFIG_ARGS[@]}" "${ISORT_CHECK_ARGS[@]}")
# shellcheck disable=SC2034
black_args=("${BLACK_CONFIG_ARGS[@]}" "${BLACK_CHECK_ARGS[@]}")
fixing=false
fix_primary=false
fix_secondary=false
should_run_primary=true
should_run_secondary=true

load_secondary_scope_paths
if [ "${#SECONDARY_SCOPE_PATHS[@]}" -eq 0 ]; then
    echo "No secondary scope paths found; forcing secondary environment check to be skipped."
    should_run_secondary=false
fi

for arg in "$@"; do
    case $arg in
        --fix)
            # shellcheck disable=SC2034
            isort_args=("${ISORT_CONFIG_ARGS[@]}")
            # shellcheck disable=SC2034
            black_args=("${BLACK_CONFIG_ARGS[@]}")
            fixing=true
            fix_primary=true
            fix_secondary=true
            ;;
        --fix-primary)
            # shellcheck disable=SC2034
            isort_args=("${ISORT_CONFIG_ARGS[@]}")
            # shellcheck disable=SC2034
            black_args=("${BLACK_CONFIG_ARGS[@]}")
            fixing=true
            fix_primary=true
            ;;
        --fix-secondary)
            # shellcheck disable=SC2034
            isort_args=("${ISORT_CONFIG_ARGS[@]}")
            # shellcheck disable=SC2034
            black_args=("${BLACK_CONFIG_ARGS[@]}")
            fixing=true
            fix_secondary=true
            ;;
        -h|--help)
            print_usage
            exit 0
            ;;
        *)
            echo "Unknown argument: $arg"
            print_usage
            exit 1
            ;;
    esac
done

if [ "$fixing" = true ]; then
    should_run_primary=$fix_primary
    should_run_secondary=$fix_secondary
    if [ "$should_run_primary" = false ] && [ "$should_run_secondary" = false ]; then
        should_run_primary=true
        should_run_secondary=true
    fi
    echo "Fix mode enabled. Running isort/black only in the selected environments."
fi

check_required_tools
run_nginx_validation

echo "Running pre push hook!"
verify_tag_if_needed
run_shellcheck_suite

run_bootstrap_checks() {
    echo "Running bootstrap checks..."
    local bootstrap_dir="$ROOT_DIR/bootstrap"
    local bootstrap_files=()
    mapfile -t bootstrap_files < <(find "$bootstrap_dir" -name "*.py" -type f)

    if [ "${#bootstrap_files[@]}" -eq 0 ]; then
        echo "No bootstrap Python files found, skipping."
        return
    fi

    echo "Running isort (bootstrap).."
    isort "${isort_args[@]}" "${bootstrap_files[@]}"

    echo "Running black (bootstrap).."
    black "${black_args[@]}" "${bootstrap_files[@]}"

    if [ "$fixing" = true ]; then
        return
    fi

    echo "Running ruff (bootstrap).."
    ruff check --config "$CORE_DIR/pyproject.toml" "${bootstrap_files[@]}"

    echo "Running pylint (bootstrap).."
    pylint --rcfile "$CORE_DIR/pyproject.toml" "${bootstrap_files[@]}"

    echo "Running mypy (bootstrap).."
    mypy --config-file "$CORE_DIR/pyproject.toml" "$bootstrap_dir"
}

if [ "$should_run_primary" = true ]; then
    run_environment_phase "primary" "$PRIMARY_PROJECT_DIR" "primary" SECONDARY_SCOPE_PATHS EMPTY_PATHS true
    # Bootstrap checks reuse the primary venv (run_environment_phase runs in a subshell so we re-activate)
    # shellcheck disable=SC1091
    source "$PRIMARY_PROJECT_DIR/.venv/bin/activate"
    run_bootstrap_checks
fi
if [ "$should_run_secondary" = true ]; then
    if [ "${#SECONDARY_SCOPE_PATHS[@]}" -eq 0 ]; then
        echo "No services assigned to the secondary environment; skipping secondary run."
    else
        run_environment_phase "secondary" "$SECONDARY_PROJECT_DIR" "secondary" EMPTY_PATHS SECONDARY_SCOPE_PATHS false "$SECONDARY_COVERAGE_THRESHOLD"
    fi
fi

exit 0
