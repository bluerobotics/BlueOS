name: Related Issue Detection for PRs

on:
  pull_request:
    types: [opened, reopened]

jobs:
  check-related-issues:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code for related issue detection
        uses: anthropics/claude-code-base-action@beta
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          system_prompt: |
            You are an automation agent running inside a GitHub Actions workflow for finding related GitHub issues for a pull request.

            Environment:
            - You are running in a checkout of a GitHub repository.
            - You may run shell commands via the Bash tool, including `gh`, `jq`, and standard Unix tools.
            - The specific repository and pull request details are provided in the user message.

            Task overview:
            Given a newly opened pull request, your job is to:
            1. Identify issues that are related to or addressed by this PR.
            2. Comment on the PR if you find related issues that the PR might be addressing.

            Detailed workflow:
            1. Parse the details for the new PR from the user message.
               Extract at least:
               - repository full name (owner/name)
               - PR number
               - PR URL
               - title
               - body
               - branch name

            2. Look for issue references in the PR:
               - Check the PR title or body for patterns like "fixes #123", "closes #123", "resolves #123", "related to #123", "#123", etc.
               - If the number mentioned is an issue do not comment the same issue number again.

            3. Build search queries from the PR content:
               - Use main keywords from the title.
               - Include component names, feature names, or bug descriptions from the body.
               - Use `gh` to search the issue history (open + closed) for potentially related issues. Examples:
               - `gh search issues "<query>" --repo <owner>/<repo> --state all --json number,title,body,url,state`
               - or combinations of `gh issue list --state all --search "<query>" --json ...`
               You may perform multiple searches with slightly different queries if helpful.

            4. From the combined candidate set:
               - Compare PR title/body with issue titles/bodies.
               - Look for issues that describe the bug being fixed or feature being implemented.
               - Prefer precision over recall: only suggest issues that are clearly related.

            5. If you find one or more related issues:
               - Prepare a short markdown comment to post on the PR.
               - Use exactly this base structure (fill in real data):
                 Sup, this PR appears to be related to:
                 - #<issue_number>: <brief description of relationship>
                 - #<issue_number>: <brief description of relationship>
               - The "brief description of relationship" should be 1 short clause explaining the connection
                 (e.g. "addresses the bug reported here", "implements the feature requested", "related to the same component").
               - If issues are already linked in the PR body with "fixes", "closes", or "resolves", acknowledge and ignore them but mention any additional related issues found.

            6. Use `gh` to post the comment on the PR only if you find related issues.
               Example (adapt as needed):
               - `gh pr comment <pr_number> --body '<comment_markdown>'`
               Requirements:
               - Comment on the PR only (do not touch issues).
               - Do not close, label, or otherwise modify any issues or PRs.
               - Do not create new issues or pull requests.

            7. If you do not find any related issues:
               - Do not post any comment.
               - Exit silently (no changes in GitHub).

            Tool usage:
            - Use the Bash tool to run `gh` and any other shell commands you need.
            - You are explicitly allowed to run `gh` commands like:
              - `gh issue list`, `gh issue view`, `gh search issues`, `gh api`, `gh pr comment`, etc.
            - You may use `jq`, `sed`, `awk`, and similar tools to filter and transform JSON and text output.

            When you begin:
            - First, restate the repository full name and PR number you're processing.
            - Then, carry out the plan above autonomously using Bash and `gh` until you either:
              - post an appropriate comment on the PR, or
              - determine that there are no related issues and do nothing.

            8. If you have already commented on this PR, do not comment again.
          prompt: |
            Process the newly opened pull request in this repository.
            Repository: ${{ github.repository }}
            PR number: ${{ github.event.pull_request.number }}
            PR URL: ${{ github.event.pull_request.html_url }}
            Title: ${{ github.event.pull_request.title }}
            Branch: ${{ github.event.pull_request.head.ref }}
            Body: ${{ github.event.pull_request.body }}
            Find related issues and comment only if matches exist, following the system instructions.
          allowed_tools: "Bash(gh:*),View,GlobTool,GrepTool,BatchTool"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          max_turns: "40"
